############
Sky-shifting
############

CWInPy can be used to produce :ref:`posterior probability distributions<Known pulsar parameter
estimation>` for the unknown signal parameters of a continuous gravitational-wave source, i.e., a
pulsar. These allow you to constrain, for example, the gravitational-wave amplitude, or orientation
of the source. However, before making inferences about a particular source's parameters it is useful
to be sure that the signal you are observing is actually astrophysical in origin. Gravitational-wave
detector data contains many non-astrophysical artifacts and also its properties vary over time,
i.e., the noise is the data is not drawn from a purely Gaussian `non-stationary process
<https://en.wikipedia.org/wiki/Stationary_process>`_ (see, e.g., [1]_). Some of these artifacts are
narrow-band spectral line features, which can wander across the frequency band of an expected signal
and potentially mimic a continuous signal to some extent [2]_. Even Gaussian noise can occasionally
conspire to look slightly "signal-like", i.e., produce posteriors in amplitude that peak away from
zero and have some coherent structure detectors.

It is therefore useful to have some way to assess whether a signal is likely to be a detector
artifact or not, i.e., compare some statistic generated from the data containing the signal to a
known background distribution of that statistic for realistic noise-only detector data. We
unfortunately cannot turn signals off or shield the detector from them to work out a noise-only
background. Given a continuous signal is at a specific frequency, the noise-only background could
potentially be generated by looking at many different frequencies. However, because the detector
noise amplitude is very frequency dependent and the spectral features vary across the band, this
means different frequencies are not very representative of the noise around our signal of interest.
This is where sky-shifting [3]_ comes in.

For a long-duration signal, its exact phase evolution is very dependent on its sky location, due to
the Doppler and relativistic modulations required for that location. Therefore, for a particular
source you can completely decohere the signal by :ref:`heterodyning<Heterodyning data>` it at the
wrong sky location. This process is slightly analogous to process of "time shifting" used to
establish the significance of transient gravitational-wave signals (see, e.g., Section 3.6 of [4]_).
If one performs the heterodyne with many random sky shifts and in each case then performs parameter
estimation on the signal and calculates an appropriate statistic, e.g., a coherent versus incoherent
Bayesian odds as given in Equation (32) of [5]_, then the distribution of this statistic can be
compared with that from the un-shifted sky location.

The sky-shifting process works as follows:

#. Perform a "coarse" heterodyne, i.e., heterodyne the data without accounting for any Doppler
corrections and just using terms of the Taylor expansion in the frequency evolution (this is the
first stage of the :ref:`"two-stage" heterodyne approach<Example: two stage heterodyne>`). Filter
and downsample the data, but making sure the filter is wide enough to accommodate the Doppler
modulation of the source.
#. Randomly generate a number of new sky locations in the same ecliptic
hemisphere as the source. For each of these new locations and the original location, perform an
additional heterodyne of the "coarse" data (this is the second stage of the :ref:`"two-stage"
heterodyne approach<Example: two stage heterodyne>`), using the expected Doppler modulation for that
position.
#. Perform :ref:`parameter estimation<Known pulsar parameter estimation>` on the
heterodyned data for each sky location (including the original un-shifted data) and calculate the
Bayesian odds (assuming a nested sampling algorithm has been used).
#. Histogram the distribution of sky-shifted odds values and perform a kernel density estimate to
compare that distribution to the value from the true un-shifted location.

To make this process easy, CWInPy provides the ``cwinpy_skyshift_pipeline`` script, which sets up
the full :ref:`known pulsar analysis pipeline<Known pulsar analysis pipeline>` for an individual
source. This can either take some "Quick setup" command-line arguments to run on open data with some
default settings or can take a ``cwinpy_knope_pipeline``-style :ref:`configuration
file<Configuration file>`. It will launch a HTCondor DAG for the whole process except production of
the odds distributions, which must be done manually (add link to function for this!).

Using the default settings, the pipeline will generate the following directory tree structure:

.. code-block:: bash

   skyshift
    ├── prior.txt          # file containing the prior to use for parameter estimation       
    ├── cache              # directory containing files listing the gravitational-wave data frames for each detector
    ├── configs            # directory containing all the configuration files for cwinpy_heterodyne and cwinpy_pe
    ├── log                # directory containing all the HTCondor job log files
    ├── pulsars            # directory containing pulsar parameter (.par) files for each sky-shifted location
    ├── results            # directory containing the parameter estimation output for each source
    |    ├── pulsar1       # directory containing the parameter estimation output for the first location
    |    ├── pulsar2       # directory containing the parameter estimation output for the second location
    |    └── ...
    ├── segments           # directory containing the data science segments to use for each pulsar
    ├── stage1             # directory containing the output of the first stage heterodyne for each detector
    |    ├── detector1     # directory containing the output of the first stage heterodyne for first detector
    |    ├── detector2     # directory containing the output of the first stage heterodyne for second detector
    |    └── ...
    ├── stage2             # directory containing the output of the second stage heterodyne for each detector and source location
    |    ├── detector1     # directory containing the output of the second stage heterodyne for first detector
    |    ├── detector2     # directory containing the output of the second stage heterodyne for second detector
    |    └── ...
    └── submit             # directory containing the HTCondor DAG file and submit files

Example: hardware injection
===========================

An easy way to test the sky-shifting analysis is by looking at one of the hardware injection
signals. The ``cwinpy_skyshift_pipeline`` script below sets up the analysis to run on O1 data for
the ``PULSAR03`` injection with 500 sky-shifts. By default this will run with both the LIGO
detectors, H1 and L1, with parameter estimation performed both coherently with both detectors and on
each of the individual detectors.

.. code-block:: bash

   cwinpy_skyshift_pipeline --run O1 --pulsar PULSAR03 --nshifts 500 --accounting-group-tag aluk.dev.o1.cw.targeted.bayesian

The above line automatically launches the HTCondor jobs that run the analysis.

.. note::

   After the pipeline completes, there will be many "resume" file that can take up a lot of space.
   It is worth moving into the ``results`` directory and deleting these, e.g.:

   .. code-block::

      rm */*.pickle

Spectra and parameter estimation
--------------------------------

To show that the sky-shifting truly does decohere any signal, we can look at spectra and the final
parameter estimation for the un-shifted result compared to a sky-shifted result. The spectra can be
plotted (from the ``skyshift`` directory) with:

.. code-block:: python

   import os
   import lal
   from cwinpy import HeterodynedData
   from matplotlib import pyplot as plt

   hetdir = "stage2"

   dets = ["H1", "L1"]
   times = {"H1": "1129136736-1137253524", "L1": "1126164689-1137250767"}

   onsource = "JPULSAR03"
   offsource = "JPULSAR03A"

   fig, ax = plt.subplots(1, 2, figsize=(9, 5))

   for i, det in enumerate(dets):
       # on source heterodyned data
       ondata = HeterodynedData.read(os.path.join(hetdir, det, f"heterodyne_{onsource}_{det}_2_{times[det]}.hdf5"))
       ondata.power_spectrum(remove_outliers=True, dt=int(lal.DAYSID_SI * 10), label="on-source", lw=2, color="k", ax=ax[i])

       # off-source (sky-shifted) data
       offdata = HeterodynedData.read(os.path.join(hetdir, det, f"heterodyne_{offsource}_{det}_2_{times[det]}.hdf5"))
       offdata.power_spectrum(remove_outliers=True, dt=int(lal.DAYSID_SI * 10), label="off-source", alpha=0.8, ls="--", ax=ax[i])

       ax[i].set_title(f"{det}")
       ax[i].legend(loc="upper right")

   fig.tight_layout()
   fig.savefig(f"skyshift_hwinj_spectrum.png", dpi=200)

.. thumbnail:: skyshifting/skyshift_hwinj_spectrum.png
   :width: 600px
   :align: center

It is obvious from these that the strong hardware injection signal has been wiped out as a result of
heterodyning using the wrong sky position.

The posterior probability distributions on the signal parameters, for the joint H1 and L1 analysis,
can be plotted with:

.. code-block:: python

   import os

   from cwinpy.info import HW_INJ
   from cwinpy.plot import Plot

   resdir = "results"

   onsource = "JPULSAR03"
   offsource = "JPULSAR03A"
   pulnum = 3

   for title, pulsar in zip(["on-source", "off-source"], [onsource, offsource]):
       resfile = os.path.join(resdir, pulsar, f"cwinpy_pe_H1L1_{pulsar}_result.hdf5")

       p = Plot(
           resfile,
           parameters=["h0", "iota", "phi0", "psi"],
           plottype="corner",
           pulsar=(HW_INJ["O1"]["hw_inj_files"][pulnum] if pulsar == "JPULSAR03" else None),
       )

       fig = p.plot()
       p.fig.suptitle(f"{title}")
       p.save(f"{pulsar}_H1L1_plot.png", dpi=200)
       p.fig.close()

.. thumbnail:: skyshifting/JPULSAR03_H1L1_plot.png
   :width: 275px
   :align: left
   :group: injection

.. thumbnail:: skyshifting/JPULSAR03A_H1L1_plot.png
   :width: 275px
   :align: right
   :group: injection

where the left image shows the "on-source" posteriors and the right the "off-source" (aka
sky-shifted) posteriors.

Example: analysis outlier
=========================

In the search for gravitational-wave signals from pulsars using LIGO O1 data [6]_, the coherent
versus incoherent signal odds for pulsar J1932+17 was an outlier when compared to these for the rest
of the pulsars in the search sample. The sky-shifting method can be used to see assess the
significance of the outlier. In this case, as in [3]_, a log-uniform prior will be used on the
gravitational-wave amplitude :math:`h_0`, and therefore a configuration file must be used to set up
the ``cwinpy_skyshift_pipeline`` rather than just using the "quick setup" options. The following
configuration file, called ``outlier.ini``, is used to run on O1 data for both LIGO detectors:

.. literalinclude:: skyshifting/exampleconfig.ini

which points to a ``prior.txt`` file containing:

.. literalinclude:: skyshifting/prior.txt

and a pulsar parameter file, as used by the O1 analysis based on observations from the `Jodrell Bank
Observatory <https://www.jodrellbank.manchester.ac.uk/research/groups/pulsars/>`__, containing:

.. literalinclude:: skyshifting/J1932+17.par

The analysis was the set up to run 500 sky-shifts with:

.. code-block:: bash

   cwinpy_skyshift_pipeline --nshifts 500 outlier.ini

When using a configuration file the HTCondor jobs do not get automatically submitted unless
specified in the file. Therefore, in this case the jobs were subsequently submitted using:

.. code-block:: bash

   condor_submit_dag submit/cwinpy_skyshift.dag

Sky-shifting references
=======================

.. [1] `D. Davis *et al*
    <https://ui.adsabs.harvard.edu/abs/2021CQGra..38m5014D/abstract>`_, *CQG*, **38**, 135014 (2021).

.. [2] `P. Covas *et al*
    <https://ui.adsabs.harvard.edu/abs/2018PhRvD..97h2002C/abstract>`_, *PRD*, **97**, 082002 (2018).

.. [3] `M. Isi, S. Mastrogiovanni, M. Pitkin & O. J. Piccinni
    <https://ui.adsabs.harvard.edu/abs/2020PhRvD.102l3027I/abstract>`_, *PRD*, **102**, 123027 (2020).

.. [4] `S. A. Usman *et al*
    <https://ui.adsabs.harvard.edu/abs/2016CQGra..33u5004U/abstract>_`, *CQG*, **33**, 215004 (2016).

.. [5] M. Pitkin, M. Isi, J. Veitch & G. Woan, `arXiv:1705.08978v1
    <https://arxiv.org/abs/1705.08978v1>`_ (2017).

.. [6] `B. P. Abbott *et al* <https://ui.adsabs.harvard.edu/abs/2017ApJ...839...12A/abstract>`_,
    *ApJ*, **839**, 12 (2017).
